生产环境应该用replicated模式运行ZooKeeper。

#### 1、弹性和性能

ZooKeeper团体应该被定位为最小化机器和网络故障的影响。实践中，团体服务器应该跨越机架、电力供应、开关，以便它们中的任何一个故障都不会导致团体中多数的服务器故障。

对于需要低延时服务（几毫秒）的应用，需要在同一个数据中心运行所有的团体服务器。某些使用场景并不需要低延时，那么为了弹性可以将团体服务器分布在多个数据中心。比如，头领选择和分布式的粗粒度锁，这两种情况下状态改变不频繁，数据中心间几十毫秒的通信开销对服务整体的性能影响相对不大。

ZooKeeper有一个***observer node***的概念，就像是一个不投票权的跟随者。在写请求期间，它们不参与达成共识，*observers*是ZK集群在不损害写性能的情况下提升了读性能。*observers*可以强化ZK集群跨数据中心分布的优势，同时不会比传统的有投票权的跟随者更影响延迟。可以把有投票权节点放置一个数据中心，并把*observers*放在另一个数据中心。

ZK是一个高可用的系统，及时地展现它的功能是关键。因此，ZK应该运行在zk专用的机器上。如果ZK服务器上有其它的应用争夺资源，会造成ZK性能显著地降级。

配置ZK让事务日志保存在和ZK snapshots不同的磁盘驱动器上。默认情况下，两者都保存在`dataDir`属性指定的目录，如果指定了`dataLogDir`，事务日志会写到`dataLogDir`指定的目录。如果ZK服务器有自己专用的设备（而不是一个分区），ZK服务器可以使写日志条目到磁盘的速率最大化（顺序地写不用寻址）。因为写操作通过leader执行，增加服务器不能扩展写通量，所以，使写速率尽量快是关键的。

如果处理转向磁盘，性能会受到影响。通过设置Java堆大小为比机器未使用的物理内存小，可以避免使用磁盘。在配置文件目录中，ZK脚本会使用*java.env*文件，其中`JVMFLAGS`环境变量指定了堆大小（和其它JVM参数）。

#### 2、配置

ZK服务器团体中的每个服务器都有一个团体中唯一的介于1~255的数值身份（identifier）。这个服务器号通过`dataDir`属性指定的目录中的`myid`文件以普通文本格式指定。还需要给每个服务器团体中所有其它服务器的身份和网络位置。ZK配置文件必须包含每个服务的信息，格式为：

```
server.n=hostname:port:port
```

其中`n`为服务器号。第一个端口是跟随者用来连接头领的，第二个端口是用于头领选择的。三台机器ZK团体配置文件的例子：

```
tickTime=2000
dataDir=/disk1/zookeeper
dataLogDir=/disk2/zookeeper
clientPort=2181
initLimit=5
syncLimit=2
server.1=zookeeper1:2888:3888
server.2=zookeeper2:2888:3888
server.3=zookeeper3:2888:3888
```

服务器从端口：2181监听客户端的连接；2888用于跟随者的连接，如果服务器是头领；3888用于头领选择阶段其它服务器的连接。当ZK服务器启动，它读取`myid`文件来决定它是哪一个服务器，然后读取配置文件来决定要监听的端口和要发现的团体中的其它服务器的网络地址。客户端应该使用`zookeeper1:2181`，`zookeeper2:2181`，`zookeeper3:2181`作为`ZooKeeper`对象构造器的host字符串来连接ZK团体。

replicated模式有两个额外的强制的参数：`initLimit`和`syncLimit`，它们都是用`ticktime`的倍数来衡量的。

`initLimit`是跟随者连接到头领和与头领同步所允许的时间。如果在这个时间内多数的跟随者不能同步，头领会放弃领导权，并发生头型选择。如果经常发生这种情况（可以通过日志发现），那么是这个设置太低的标识。

`syncLimit`是某一个跟随者与头领同步的允许时间。如果跟随者在这段时间内不能与头领同步，它会重启自己。与这个跟随者连接的客户端则转向连接其它跟随者。

更多配置详情参考ZK官方文档。